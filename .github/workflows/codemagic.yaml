name: Build Android and upload to BrowserStack

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch: {}

jobs:
  build-android-and-upload-browserstack:
    name: Build Android (APK + AAB) and upload to BrowserStack
    runs-on: ubuntu-latest
    env:
      FLUTTER_VERSION: 3.38.3
      # ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      ANDROID_KEYSTORE_BASE64: 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
       #之後你要改成${{KEYSTORE_PASSWORD }}
      KEYSTORE_PASSWORD: Popoman1217!
      #之後你要改成${{ secrets.KEY_PASSWORD }}
      KEY_PASSWORD: Popoman1217!
      #之後你要改成${{ secrets.KEY_ALIAS }}
      KEY_ALIAS: my_app_alias
      #之後你要改成${{ secrets.BROWSERSTACK_USERNAME }}
      BROWSERSTACK_USERNAME: peichenlee_0zP9MX  
      #之後你要改成${{ secrets.BROWSERSTACK_ACCESS_KEY }}
      BROWSERSTACK_ACCESS_KEY: mxMRzp4bkAHqQyyFP8ce
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.3'
          channel: 'stable'

      - name: Verify Flutter installation
        run: |
          flutter --version
          flutter doctor -v || true


      - name: Decode Android keystore and create key.properties
        run: |
          set -eo pipefail
          mkdir -p my_mindhelp_app/android/app
          if [ -z "${ANDROID_KEYSTORE_BASE64}" ]; then
            echo "ERROR: ANDROID_KEYSTORE_BASE64 is empty"
            exit 2
          fi
          echo "Decoding keystore..."
          echo "${ANDROID_KEYSTORE_BASE64}" | base64 -d > my_mindhelp_app/android/app/keystore.jks
          chmod 600 my_mindhelp_app/android/app/keystore.jks
          printf "storePassword=%s\nkeyPassword=%s\nkeyAlias=%s\nstoreFile=app/keystore.jks\n" "${KEYSTORE_PASSWORD}" "${KEY_PASSWORD}" "${KEY_ALIAS}" > my_mindhelp_app/android/key.properties
          echo "Created my_mindhelp_app/android/key.properties"

      - name: Install dependencies
        run: |
          set -eo pipefail
          cd my_mindhelp_app
          flutter pub get --no-precompile

      - name: Flutter analyze
        run: |
          set -eo pipefail
          cd my_mindhelp_app
          flutter analyze || true

      - name: Flutter test
        run: |
          set -eo pipefail
          cd my_mindhelp_app
          flutter test --no-pub || true

      - name: Build APK (release)
        run: |
          set -eo pipefail
          cd my_mindhelp_app
          flutter build apk --release

      - name: Build AAB (release)
        run: |
          set -eo pipefail
          cd my_mindhelp_app
          flutter build appbundle --release

      - name: Upload artifacts to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          path: |
            my_mindhelp_app/build/app/outputs/flutter-apk/*.apk
            my_mindhelp_app/build/app/outputs/bundle/release/*.aab

      - id: upload-apk
        name: Upload APK to BrowserStack App Automate
        run: |
          set -eo pipefail
          # Ensure jq is available for JSON parsing
          sudo apt-get update -y && sudo apt-get install -y jq

          APK_PATH=$(ls my_mindhelp_app/build/app/outputs/flutter-apk/*.apk 2>/dev/null | head -n 1 || true)
          if [ -z "${APK_PATH}" ]; then
            echo "ERROR: APK not found"
            exit 3
          fi

          echo "Uploading ${APK_PATH} to BrowserStack App Automate..."
          UPLOAD_RESPONSE=$(curl -s -u "${BROWSERSTACK_USERNAME}:${BROWSERSTACK_ACCESS_KEY}" \
            -X POST "https://api-cloud.browserstack.com/app-automate/upload" \
            -F "file=@${APK_PATH}")

          echo "Upload response: ${UPLOAD_RESPONSE}"
          APP_URL=$(echo "${UPLOAD_RESPONSE}" | jq -r .app_url || echo "")
          if [ -z "${APP_URL}" ] || [ "${APP_URL}" = "null" ]; then
            echo "ERROR: Failed to extract app_url from BrowserStack response"
            exit 4
          fi
          echo "BrowserStack app_url=${APP_URL}"
          echo "app_url=${APP_URL}" >> $GITHUB_OUTPUT

      - name: Show BrowserStack app_url
        run: |
          echo "BrowserStack app_url: ${{ steps.upload-apk.outputs.app_url }}"
